<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fitness Quest</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <style>
    /* CSS Variables */
    :root {
        --safe-area-inset-top: env(safe-area-inset-top);
        --safe-area-inset-bottom: env(safe-area-inset-bottom);
        --background-color: #121212;
        --secondary-bg: #252525;
        --text-color: white;
        --accent-color: #8BC5BF;
        --accent-hover: #E4BAC1;
        --ios-bottom-safe-area: 34px;
        --warning-color: #ff4444;
        --upcoming-color: #4444ff;
        --success-color: #44ff44;
        --neutral-text: #8a8a8a;
        --xp-color: #FFD700;
        --attribute-strength: #ff7676;
        --attribute-endurance: #76ff76;
        --attribute-agility: #7676ff;
        --attribute-discipline: #ffff76;
        --attribute-resilience: #ff76ff;
    }

    /* Reset and Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
        padding-top: calc(var(--safe-area-inset-top) + 10px);
        padding-bottom: calc(var(--safe-area-inset-bottom) + var(--ios-bottom-safe-area));
    }

    /* Layout */
    .container {
        max-width: 430px;
        margin: 0 auto;
        padding: 10px;
    }

    /* Character Stats Section */
    .character-stats {
        background: linear-gradient(to bottom right, #2a2a2a, #1a1a1a);
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .level-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .level-number {
        font-size: 24px;
        font-weight: bold;
        color: var(--xp-color);
    }

    .xp-bar {
        background: rgba(255,255,255,0.1);
        height: 6px;
        border-radius: 3px;
        margin: 8px 0;
        overflow: hidden;
    }

    .xp-fill {
        height: 100%;
        background: var(--xp-color);
        transition: width 0.3s ease;
    }

    .attributes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 16px;
    }

    .attribute {
        background: rgba(255,255,255,0.05);
        padding: 12px;
        border-radius: 8px;
        position: relative;
    }

    .attribute-name {
        font-size: 14px;
        margin-bottom: 4px;
    }

    .attribute-bar {
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        overflow: hidden;
    }

    .attribute-fill {
        height: 100%;
        transition: width 0.3s ease;
    }

    .attribute-fill.strength { background: var(--attribute-strength); }
    .attribute-fill.endurance { background: var(--attribute-endurance); }
    .attribute-fill.agility { background: var(--attribute-agility); }
    .attribute-fill.discipline { background: var(--attribute-discipline); }
    .attribute-fill.resilience { background: var(--attribute-resilience); }

    /* Header with Points */
    .header {
        background-color: var(--secondary-bg);
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .points-display {
        background: rgba(255,255,255,0.1);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 500;
        color: var(--xp-color);
        display: flex;
        align-items: center;
        gap: 6px;
    }

            /* Reward Shop Styles */
    .reward-shop {
        background: linear-gradient(to bottom right, #2a2a2a, #1a1a1a);
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 16px;
    }

    .reward-categories {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 8px;
        margin-bottom: 16px;
    }

    .reward-category {
        padding: 8px 16px;
        background: rgba(255,255,255,0.1);
        border-radius: 20px;
        white-space: nowrap;
        border: none;
        color: var(--text-color);
        cursor: pointer;
    }

    .reward-category.active {
        background: var(--accent-color);
        color: var(--background-color);
    }

    .reward-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .reward-item {
        background: rgba(255,255,255,0.05);
        padding: 16px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .reward-item:hover {
        transform: translateY(-2px);
    }

    .reward-icon {
        font-size: 24px;
    }

    .reward-info {
        flex-grow: 1;
    }

    .reward-name {
        font-weight: 500;
        margin-bottom: 4px;
    }

    .reward-cost {
        color: var(--xp-color);
        font-weight: bold;
    }

    /* Navigation Updates */
    .nav-buttons {
        position: fixed;
        bottom: calc(var(--safe-area-inset-bottom) + 15px);
        left: 0;
        right: 0;
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        background-color: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 1000;
    }

    .nav-button {
        background-color: var(--secondary-bg);
        color: var(--text-color);
        border: none;
        padding: 12px;
        border-radius: 12px;
        cursor: pointer;
        flex: 1;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .nav-icon {
        font-size: 20px;
    }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Character Level -->
        <div class="header">
            <div class="level-display">
                <h1 id="current-date">Today's Quest</h1>
                <span id="schedule-type" class="day-type">Loading...</span>
            </div>
            <div class="points-display">
                <span class="points-icon">üéØ</span>
                <span id="points-amount">0</span>
            </div>
        </div>

        <!-- Character Stats Section -->
        <div id="character-stats" class="character-stats" style="display: none;">
            <div class="level-info">
                <div class="level-title">Level <span id="character-level">1</span></div>
                <div class="level-number">Fitness Warrior</div>
            </div>
            <div class="xp-bar">
                <div id="xp-fill" class="xp-fill" style="width: 0%"></div>
            </div>
            <div class="xp-text">
                <span id="current-xp">0</span> / <span id="next-level-xp">1000</span> XP
            </div>
            <div class="attributes">
                <div class="attribute">
                    <div class="attribute-name">üí™ Strength</div>
                    <div class="attribute-bar">
                        <div id="strength-fill" class="attribute-fill strength" style="width: 10%"></div>
                    </div>
                </div>
                <div class="attribute">
                    <div class="attribute-name">‚ù§Ô∏è Endurance</div>
                    <div class="attribute-bar">
                        <div id="endurance-fill" class="attribute-fill endurance" style="width: 10%"></div>
                    </div>
                </div>
                <!-- More attributes... -->
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section">
            <h3>Today's Progress</h3>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="today-completed">0</div>
                    <div>Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="week-completed">0</div>
                    <div>This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="streak-count">0</div>
                    <div>Day Streak</div>
                </div>
            </div>
        </div>

        <!-- Views -->
        <div id="daily-view"></div>
        <div id="week-view" class="week-view"></div>
        <div id="rewards-view" class="rewards-view" style="display: none;"></div>
    </div>

    <!-- Updated Navigation -->
    <div class="nav-buttons">
        <button class="nav-button active" onclick="showView('today')">
            <span class="nav-icon">üìã</span>
            <span>Today</span>
        </button>
        <button class="nav-button" onclick="showView('character')">
            <span class="nav-icon">‚öîÔ∏è</span>
            <span>Character</span>
        </button>
        <button class="nav-button" onclick="showView('rewards')">
            <span class="nav-icon">üéÅ</span>
            <span>Rewards</span>
        </button>
        <button class="nav-button" onclick="showView('week')">
            <span class="nav-icon">üìÖ</span>
            <span>Week</span>
        </button>
    </div>
    // Configuration and Constants
const CONFIG = {
    TIME: {
        UPCOMING_THRESHOLD: 30,
        GRACE_PERIOD: 15,
        CHECK_INTERVAL: 60000,
        SYNC_INTERVAL: 30000
    },
    TOUCH: {
        TAP_THRESHOLD: 10,
        SWIPE_THRESHOLD: 50,
        PULL_THRESHOLD: 100,
        MAX_PULL_DISTANCE: 150
    },
    HAPTIC: {
        LIGHT: 10,
        MEDIUM: [15, 15],
        HEAVY: [20, 20, 20]
    },
    ANIMATION: {
        CONFETTI_COUNT: 30,
        ACHIEVEMENT_DURATION: 3000,
        NUMBER_STEPS: 10
    }
};

// Gamification Configuration
const GAMIFICATION_CONFIG = {
    XP_REWARDS: {
        TASK_COMPLETION: 100,
        ON_TIME_BONUS: 50,
        STREAK_MILESTONE: 500,
        PERFECT_DAY: 1000,
        WEEKLY_GOAL: 2000,
        ATTRIBUTE_MILESTONE: 300
    },
    ATTRIBUTE_GAINS: {
        GYM_WORKOUT: {
            strength: 2,
            discipline: 1
        },
        RUNNING: {
            endurance: 2,
            agility: 1
        },
        RECOVERY: {
            resilience: 2,
            discipline: 1
        },
        MOBILITY: {
            agility: 1,
            resilience: 1
        }
    },
    REWARDS: {
        FOOD: {
            PRETZEL: { 
                id: 'pretzel',
                name: "Favorite Pretzel",
                description: "Treat yourself to that pretzel you love",
                points: 500, 
                cooldown: 3 * 24 * 60 * 60 * 1000,
                icon: "ü•®"
            },
            COFFEE: { 
                id: 'coffee',
                name: "Coffee Shop Visit",
                description: "Your favorite coffee and pastry combo",
                points: 800, 
                cooldown: 4 * 24 * 60 * 60 * 1000,
                icon: "‚òï"
            },
            RESTAURANT: { 
                id: 'restaurant',
                name: "Restaurant Meal",
                description: "Enjoy a meal at your chosen restaurant (up to ¬£30)",
                points: 3000, 
                cooldown: 14 * 24 * 60 * 60 * 1000,
                icon: "üçΩÔ∏è"
            }
        },
        REST: {
            SLEEP_IN: { 
                id: 'sleep_in',
                name: "Sleep In Day",
                description: "Start your schedule 1 hour later",
                points: 1000, 
                cooldown: 7 * 24 * 60 * 60 * 1000,
                icon: "üò¥"
            },
            REST_DAY: { 
                id: 'rest_day',
                name: "Rest Day",
                description: "Redeem a guilt-free rest day",
                points: 2500, 
                cooldown: 14 * 24 * 60 * 60 * 1000,
                icon: "üåü"
            }
        },
        SHOPPING: {
            SMALL_ITEM: { 
                id: 'small_item',
                name: "Online Shopping (¬£10)",
                description: "Treat yourself to something nice",
                points: 2000, 
                cooldown: 7 * 24 * 60 * 60 * 1000,
                icon: "üõçÔ∏è"
            },
            MEDIUM_ITEM: { 
                id: 'medium_item',
                name: "Fitness Gear (¬£20)",
                description: "New workout gear or accessories",
                points: 4000, 
                cooldown: 30 * 24 * 60 * 60 * 1000,
                icon: "üëï"
            }
        }
    },
    STREAK_BONUSES: {
        3: { multiplier: 1.1, name: "Dedicated" },
        7: { multiplier: 1.25, name: "Consistent" },
        14: { multiplier: 1.5, name: "Committed" },
        30: { multiplier: 2.0, name: "Legendary" }
    },
    ACHIEVEMENTS: {
        EARLY_BIRD: {
            id: 'early_bird',
            name: 'Early Bird',
            description: 'Complete morning routine before 8 AM',
            xp: 300,
            icon: 'üåÖ'
        },
        STRENGTH_MILESTONE: {
            id: 'strength_milestone',
            name: 'Strength Milestone',
            description: 'Complete 5 gym workouts in a week',
            xp: 500,
            icon: 'üí™'
        },
        PERFECT_WEEK: {
            id: 'perfect_week',
            name: 'Perfect Week',
            description: 'Complete all tasks for 7 days straight',
            xp: 1000,
            icon: 'üåü'
        }
        // More achievements...
    }
};

// Game State
let gameState = JSON.parse(localStorage.getItem('gameState')) || {
    character: {
        level: 1,
        experience: 0,
        nextLevelXp: 1000,
        points: 0,
        attributes: {
            strength: 10,
            endurance: 10,
            agility: 10,
            discipline: 10,
            resilience: 10
        },
        achievements: [],
        title: 'Novice Athlete',
        streakBonus: 1.0
    },
    progress: {
        completedTasks: {},
        streaks: 0,
        lastCompletedDate: null,
        weeklyStats: {},
        lastSync: new Date().toISOString(),
        taskTimings: {}
    },
    rewards: {
        available: [],
        redeemed: [],
        cooldowns: {}
    }
};

// Game Systems
const GameSystems = {
    calculateNextLevelXp(level) {
        return Math.floor(1000 * Math.pow(1.5, level - 1));
    },

    awardExperience(amount) {
        const bonusXp = Math.floor(amount * gameState.character.streakBonus);
        gameState.character.experience += bonusXp;
        
        while (gameState.character.experience >= gameState.character.nextLevelXp) {
            gameState.character.experience -= gameState.character.nextLevelXp;
            gameState.character.level++;
            gameState.character.nextLevelXp = this.calculateNextLevelXp(gameState.character.level);
            this.handleLevelUp();
        }

        this.updateCharacterUI();
        this.saveGameState();
    },

    handleLevelUp() {
        UI.showAchievement(`Level Up! üéâ\nYou're now level ${gameState.character.level}!`);
        Utils.triggerHapticFeedback('heavy');
        
        // Award level-up bonus
        gameState.character.points += 500;
        
        // Update character title based on level
        this.updateCharacterTitle();
    },

    updateCharacterTitle() {
        const titles = {
            1: 'Novice Athlete',
            5: 'Dedicated Trainee',
            10: 'Fitness Enthusiast',
            15: 'Elite Performer',
            20: 'Fitness Master',
            30: 'Legendary Athlete'
        };

        for (const [level, title] of Object.entries(titles).reverse()) {
            if (gameState.character.level >= parseInt(level)) {
                gameState.character.title = title;
                break;
            }
        }
    },

    updateAttributes(activityType) {
        const gains = GAMIFICATION_CONFIG.ATTRIBUTE_GAINS[activityType];
        if (gains) {
            Object.entries(gains).forEach(([attribute, amount]) => {
                const oldValue = gameState.character.attributes[attribute];
                gameState.character.attributes[attribute] = Math.min(100, oldValue + amount);
                
                // Check if we crossed a milestone (every 10 points)
                if (Math.floor(oldValue / 10) < Math.floor(gameState.character.attributes[attribute] / 10)) {
                    this.handleAttributeMilestone(attribute);
                }
            });
        }
        this.updateCharacterUI();
    },

    handleAttributeMilestone(attribute) {
        const capitalizedAttribute = attribute.charAt(0).toUpperCase() + attribute.slice(1);
        UI.showAchievement(`${capitalizedAttribute} Milestone! üéØ\nYour ${attribute} has reached a new tier!`);
        this.awardExperience(GAMIFICATION_CONFIG.XP_REWARDS.ATTRIBUTE_MILESTONE);
    },
